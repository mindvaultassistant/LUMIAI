import 'package:flutter/material.dart';
import 'package:flutter/services.dart';

class MainShell extends StatefulWidget {
  final dynamic settings; // AppSettingsController
  const MainShell({super.key, required this.settings});

  @override
  State<MainShell> createState() => _MainShellState();
}

class _MainShellState extends State<MainShell> {
  final _prompt = TextEditingController();

  List<_TemplateItem> get _templates => const [
        _TemplateItem(
          title: 'Instagram Satış Postu',
          subtitle: 'Dokun → prompt dolsun',
          icon: Icons.shopping_bag_rounded,
          prompt:
              'Instagram satış postu yaz: Ürün adı: {ürün}, Fiyat: {fiyat}, Hedef kitle: {kitle}. 1 başlık + 1 kısa açıklama + 5 madde fayda + CTA + 8 hashtag.',
        ),
        _TemplateItem(
          title: 'Viral Reels Fikri',
          subtitle: 'Dokun → prompt dolsun',
          icon: Icons.play_circle_fill_rounded,
          prompt:
              'Viral Reels fikri üret: Niş: {niş}. 5 farklı konsept ver. Her biri için: Hook (1 cümle), sahne planı (5 adım), ekrana yazılacak metinler, CTA.',
        ),
        _TemplateItem(
          title: 'SEO Blog Yazısı',
          subtitle: 'Dokun → prompt dolsun',
          icon: Icons.article_rounded,
          prompt:
              'SEO blog yazısı taslağı: Ana anahtar kelime: {keyword}. H1 + H2/H3 yapı, meta açıklama, giriş, 7 alt başlık, sonuç, 5 SSS ve iç link önerileri.',
        ),
        _TemplateItem(
          title: 'Ürün Açıklaması',
          subtitle: 'Dokun → prompt dolsun',
          icon: Icons.label_rounded,
          prompt:
              'E-ticaret ürün açıklaması yaz: Ürün: {ürün}. Ton: premium. 1 kısa özet, 6 fayda, teknik özellik tablo gibi, kime uygun, iade/garanti metni.',
        ),
        _TemplateItem(
          title: 'Görsel Prompt (Ultra)',
          subtitle: 'Dokun → prompt dolsun',
          icon: Icons.auto_awesome_rounded,
          prompt:
              'Görsel üretim promptu yaz: Stil: {stil}. Konu: {konu}. Işık, lens, kompozisyon, arka plan, renk paleti, negatif prompt dahil. 2 varyasyon ver.',
        ),
        _TemplateItem(
          title: 'Marka Slogan + Bio',
          subtitle: 'Dokun → prompt dolsun',
          icon: Icons.campaign_rounded,
          prompt:
              'Marka için 10 slogan + Instagram bio yaz. Marka: {marka}. Değerler: {değerler}. Hedef kitle: {kitle}. Bio: TR/EN 2 versiyon.',
        ),
        _TemplateItem(
          title: 'Film Sahnesi',
          subtitle: 'Dokun → prompt dolsun',
          icon: Icons.movie_creation_rounded,
          prompt:
              'Film sahnesi yaz: Tür: {tür}. Mekân: {mekân}. Karakterler: {karakter}. 1 sayfalık diyalog + aksiyon + duygu tonu.',
        ),
        _TemplateItem(
          title: 'Storyboard + Shotlist',
          subtitle: 'Dokun → prompt dolsun',
          icon: Icons.view_quilt_rounded,
          prompt:
              'Storyboard + shotlist hazırla: Video amacı: {amaç}. Süre: {süre}. Her shot için: plan türü, kamera hareketi, kadraj, ışık, ekranda metin, ses.',
        ),
      ];

  @override
  void dispose() {
    _prompt.dispose();
    super.dispose();
  }

  void _fillPrompt(_TemplateItem t) async {
    _prompt.text = t.prompt;
    HapticFeedback.selectionClick();
    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(content: Text('${t.title} prompt eklendi')),
      );
    }
  }

  String _balanceText() {
    try {
      final v = widget.settings.value;
      final coins = (v.coins ?? v.balance ?? 999).toString();
      return coins;
    } catch (_) {
      return '999';
    }
  }

  Future<void> _openSettingsSheet({bool focusLanguage = false}) async {
    final controller = widget.settings;

    ThemeMode curTheme;
    Locale? curLocale;

    try {
      curTheme = controller.value.themeMode as ThemeMode;
    } catch (_) {
      curTheme = ThemeMode.system;
    }

    try {
      curLocale = controller.value.locale as Locale?;
    } catch (_) {
      curLocale = null;
    }

    final supported = <Locale>[
      const Locale('tr'),
      const Locale('en'),
      const Locale('es'),
      const Locale('fr'),
      const Locale('de'),
      const Locale('ar'),
      const Locale('ru'),
    ];

    if (!mounted) return;

    await showModalBottomSheet(
      context: context,
      backgroundColor: const Color(0xFF0B0D12),
      shape: const RoundedRectangleBorder(
        borderRadius: BorderRadius.vertical(top: Radius.circular(22)),
      ),
      builder: (_) {
        return Padding(
          padding: const EdgeInsets.fromLTRB(16, 14, 16, 18),
          child: SafeArea(
            top: false,
            child: Column(
              mainAxisSize: MainAxisSize.min,
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Row(
                  children: [
                    const Icon(Icons.tune_rounded, color: Colors.white),
                    const SizedBox(width: 10),
                    const Text(
                      'Ayarlar',
                      style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.w700),
                    ),
                    const Spacer(),
                    IconButton(
                      onPressed: () => Navigator.pop(context),
                      icon: const Icon(Icons.close_rounded, color: Colors.white),
                    )
                  ],
                ),
                const SizedBox(height: 8),

                // Theme
                const Text('Tema', style: TextStyle(color: Colors.white70, fontWeight: FontWeight.w600)),
                const SizedBox(height: 8),
                _segmentedTheme(
                  current: curTheme,
                  onChange: (m) async {
                    try {
                      await controller.setThemeMode(m);
                    } catch (_) {}
                    if (mounted) setState(() {});
                  },
                ),

                const SizedBox(height: 16),

                // Language
                const Text('Dil', style: TextStyle(color: Colors.white70, fontWeight: FontWeight.w600)),
                const SizedBox(height: 8),
                Wrap(
                  spacing: 10,
                  runSpacing: 10,
                  children: supported.map((loc) {
                    final selected = (curLocale?.languageCode == loc.languageCode);
                    return InkWell(
                      onTap: () async {
                        try {
                          await controller.setLocale(loc);
                        } catch (_) {}
                        if (mounted) setState(() {});
                        Navigator.pop(context);
                      },
                      borderRadius: BorderRadius.circular(14),
                      child: Container(
                        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
                        decoration: BoxDecoration(
                          color: selected ? const Color(0xFF2C7CFF) : const Color(0xFF151926),
                          borderRadius: BorderRadius.circular(14),
                          border: Border.all(color: selected ? const Color(0xFF2C7CFF) : const Color(0xFF23283A)),
                        ),
                        child: Text(
                          loc.languageCode.toUpperCase(),
                          style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w700),
                        ),
                      ),
                    );
                  }).toList(),
                ),

                const SizedBox(height: 14),
              ],
            ),
          ),
        );
      },
    );
  }

  @override
  Widget build(BuildContext context) {
    final isDark = Theme.of(context).brightness == Brightness.dark;

    return Scaffold(
      extendBodyBehindAppBar: true,
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        elevation: 0,
        title: const Text(
          'LumiAI',
          style: TextStyle(fontWeight: FontWeight.w800, letterSpacing: 0.2),
        ),
        actions: [
          IconButton(
            onPressed: () => _openSettingsSheet(),
            icon: const Icon(Icons.settings_rounded),
            tooltip: 'Settings',
          ),
          IconButton(
            onPressed: () => _openSettingsSheet(focusLanguage: true),
            icon: const Icon(Icons.language_rounded),
            tooltip: 'Language',
          ),
          const SizedBox(width: 6),
        ],
      ),
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: isDark
                ? const [Color(0xFF070A12), Color(0xFF0B1230), Color(0xFF070A12)]
                : const [Color(0xFFF6F7FB), Color(0xFFEFF2FF), Color(0xFFF6F7FB)],
          ),
        ),
        child: SafeArea(
          child: ListView(
            padding: const EdgeInsets.fromLTRB(16, 10, 16, 18),
            children: [
              _balanceCard(balance: _balanceText()),

              const SizedBox(height: 14),

              _promptCard(controller: _prompt),

              const SizedBox(height: 14),

              const Text(
                'Templates',
                style: TextStyle(fontSize: 16, fontWeight: FontWeight.w800),
              ),
              const SizedBox(height: 10),

              GridView.builder(
                shrinkWrap: true,
                physics: const NeverScrollableScrollPhysics(),
                itemCount: _templates.length,
                gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
                  crossAxisCount: 2,
                  mainAxisSpacing: 12,
                  crossAxisSpacing: 12,
                  childAspectRatio: 1.55,
                ),
                itemBuilder: (_, i) {
                  final t = _templates[i];
                  return _templateCard(
                    title: t.title,
                    subtitle: t.subtitle,
                    icon: t.icon,
                    onTap: () => _fillPrompt(t),
                  );
                },
              ),

              const SizedBox(height: 16),

              _primaryButton(
                text: 'Generate',
                onTap: () {
                  final text = _prompt.text.trim();
                  ScaffoldMessenger.of(context).showSnackBar(
                    SnackBar(content: Text(text.isEmpty ? 'Önce prompt yaz / şablon seç' : 'Generate (demo): çalışıyor ✅')),
                  );
                },
              ),
            ],
          ),
        ),
      ),
    );
  }
}

Widget _balanceCard({required String balance}) {
  return Container(
    padding: const EdgeInsets.all(14),
    decoration: BoxDecoration(
      borderRadius: BorderRadius.circular(18),
      border: Border.all(color: const Color(0xFF23283A)),
      color: const Color(0xFF0B0D12).withOpacity(0.78),
      boxShadow: const [
        BoxShadow(blurRadius: 24, spreadRadius: 0, offset: Offset(0, 10), color: Color(0x33000000)),
      ],
    ),
    child: Row(
      children: [
        Container(
          width: 38,
          height: 38,
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(14),
            gradient: const LinearGradient(colors: [Color(0xFF2C7CFF), Color(0xFF7A5CFF)]),
          ),
          child: const Icon(Icons.auto_awesome_rounded, color: Colors.white),
        ),
        const SizedBox(width: 12),
        const Expanded(
          child: Text(
            'Your balance',
            style: TextStyle(color: Colors.white70, fontWeight: FontWeight.w600),
          ),
        ),
        Text(
          balance,
          style: const TextStyle(color: Colors.white, fontSize: 20, fontWeight: FontWeight.w900),
        ),
        const SizedBox(width: 6),
        const Text('Coins', style: TextStyle(color: Colors.white70, fontWeight: FontWeight.w700)),
      ],
    ),
  );
}

Widget _promptCard({required TextEditingController controller}) {
  return Container(
    padding: const EdgeInsets.all(14),
    decoration: BoxDecoration(
      borderRadius: BorderRadius.circular(18),
      border: Border.all(color: const Color(0xFF23283A)),
      color: const Color(0xFF0B0D12).withOpacity(0.78),
      boxShadow: const [
        BoxShadow(blurRadius: 24, spreadRadius: 0, offset: Offset(0, 10), color: Color(0x33000000)),
      ],
    ),
    child:     SingleChildScrollView(
      physics: const BouncingScrollPhysics(),
      child:       FittedBox(
        fit: BoxFit.scaleDown,
        alignment: Alignment.topLeft,
        child: Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        const Text('Prompt', style: TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.w900)),
        const SizedBox(height: 10),
        Container(
          decoration: BoxDecoration(
            color: const Color(0xFF151926),
            borderRadius: BorderRadius.circular(16),
            border: Border.all(color: const Color(0xFF23283A)),
          ),
          padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
          child: TextField(
            controller: controller,
            maxLines: 6,
            style: const TextStyle(color: Colors.white),
            decoration: const InputDecoration(
              border: InputBorder.none,
              hintText: 'Type your request...',
              hintStyle: TextStyle(color: Colors.white54),
            ),
          ),
        ),
        const SizedBox(height: 10),
        const Text('Cost: 5 coins', style: TextStyle(color: Colors.white60, fontWeight: FontWeight.w700)),
      ],
    ),
      ),
    ),
  );
}

Widget _templateCard({
  required String title,
  required String subtitle,
  required IconData icon,
  required VoidCallback onTap,
}) {
  return InkWell(
    onTap: onTap,
    borderRadius: BorderRadius.circular(18),
    child: Container(
      padding: const EdgeInsets.all(14),
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(18),
        border: Border.all(color: const Color(0xFF23283A)),
        color: const Color(0xFF0B0D12).withOpacity(0.72),
      ),
      child:       FittedBox(
        fit: BoxFit.scaleDown,
        alignment: Alignment.topLeft,
        child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Container(
            width: 34,
            height: 34,
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(14),
              color: const Color(0xFF151926),
              border: Border.all(color: const Color(0xFF23283A)),
            ),
            child: Icon(icon, color: Colors.white),
          ),
          const Spacer(),
          Text(title, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w900)),
          const SizedBox(height: 4),
          Text(subtitle, style: const TextStyle(color: Colors.white60, fontWeight: FontWeight.w700)),
        ],
      ),
      ),
    ),
  );
}

Widget _primaryButton({required String text, required VoidCallback onTap}) {
  return InkWell(
    onTap: onTap,
    borderRadius: BorderRadius.circular(18),
    child: Container(
      height: 54,
      alignment: Alignment.center,
      decoration: BoxDecoration(
        borderRadius: BorderRadius.circular(18),
        gradient: const LinearGradient(colors: [Color(0xFF2C7CFF), Color(0xFF7A5CFF)]),
        boxShadow: const [
          BoxShadow(blurRadius: 26, offset: Offset(0, 12), color: Color(0x44000000)),
        ],
      ),
      child: Text(text, style: const TextStyle(color: Colors.white, fontSize: 16, fontWeight: FontWeight.w900)),
    ),
  );
}

Widget _segmentedTheme({required ThemeMode current, required ValueChanged<ThemeMode> onChange}) {
  Widget chip(String label, ThemeMode mode) {
    final selected = current == mode;
    return InkWell(
      onTap: () => onChange(mode),
      borderRadius: BorderRadius.circular(14),
      child: Container(
        padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 10),
        decoration: BoxDecoration(
          color: selected ? const Color(0xFF2C7CFF) : const Color(0xFF151926),
          borderRadius: BorderRadius.circular(14),
          border: Border.all(color: selected ? const Color(0xFF2C7CFF) : const Color(0xFF23283A)),
        ),
        child: Text(label, style: const TextStyle(color: Colors.white, fontWeight: FontWeight.w800)),
      ),
    );
  }

  return Wrap(
    spacing: 10,
    runSpacing: 10,
    children: [
      chip('System', ThemeMode.system),
      chip('Dark', ThemeMode.dark),
      chip('Light', ThemeMode.light),
    ],
  );
}

class _TemplateItem {
  final String title;
  final String subtitle;
  final IconData icon;
  final String prompt;
  const _TemplateItem({
    required this.title,
    required this.subtitle,
    required this.icon,
    required this.prompt,
  });
}
